___TERMS_OF_SERVICE___

By creating or modifying this file you agree to Google Tag Manager's Community
Template Gallery Developer Terms of Service available at
https://developers.google.com/tag-manager/gallery-tos (or such other URL as
Google may provide), as modified from time to time.


___INFO___

{
  "type": "TAG",
  "id": "cvt_temp_public_id",
  "version": 1,
  "securityGroups": [],
  "displayName": "Across Simple Conversion Code",
  "categories": [
    "ADVERTISING",
    "MARKETING",
    "CONVERSIONS"
  ],
  "brand": {
    "id": "github.com_across-it",
    "displayName": "across",
    "thumbnail": "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGAAAABgCAYAAADimHc4AAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAyVpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDYuMC1jMDAyIDc5LjE2NDQ2MCwgMjAyMC8wNS8xMi0xNjowNDoxNyAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvIiB4bWxuczp4bXBNTT0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL21tLyIgeG1sbnM6c3RSZWY9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9zVHlwZS9SZXNvdXJjZVJlZiMiIHhtcDpDcmVhdG9yVG9vbD0iQWRvYmUgUGhvdG9zaG9wIDIxLjIgKE1hY2ludG9zaCkiIHhtcE1NOkluc3RhbmNlSUQ9InhtcC5paWQ6RjNBMTQyODVERjlBMTFFQTkwMTE4NTUxMjVFOTUwRjQiIHhtcE1NOkRvY3VtZW50SUQ9InhtcC5kaWQ6RjNBMTQyODZERjlBMTFFQTkwMTE4NTUxMjVFOTUwRjQiPiA8eG1wTU06RGVyaXZlZEZyb20gc3RSZWY6aW5zdGFuY2VJRD0ieG1wLmlpZDpGM0ExNDI4M0RGOUExMUVBOTAxMTg1NTEyNUU5NTBGNCIgc3RSZWY6ZG9jdW1lbnRJRD0ieG1wLmRpZDpGM0ExNDI4NERGOUExMUVBOTAxMTg1NTEyNUU5NTBGNCIvPiA8L3JkZjpEZXNjcmlwdGlvbj4gPC9yZGY6UkRGPiA8L3g6eG1wbWV0YT4gPD94cGFja2V0IGVuZD0iciI/PqyK/dwAAAgjSURBVHja7F0L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"
  },
  "description": "This template tracks user actions on your website and sends the data to Across statistics.",
  "containerContexts": [
    "WEB"
  ]
}


___TEMPLATE_PARAMETERS___

[
  {
    "type": "TEXT",
    "name": "campaign_id",
    "displayName": "Campaign ID",
    "simpleValueType": true,
    "valueValidators": [
      {
        "type": "NON_EMPTY"
      },
      {
        "type": "POSITIVE_NUMBER"
      }
    ],
    "help": "Campaign ID provided in setup phase by Across account"
  },
  {
    "type": "SELECT",
    "name": "action_number",
    "displayName": "Conversion  Type",
    "macrosInSelect": false,
    "selectItems": [
      {
        "value": 1,
        "displayValue": "1"
      },
      {
        "value": 2,
        "displayValue": "2"
      }
    ],
    "simpleValueType": true,
    "defaultValue": 1,
    "help": "User conversion type, available for multi-step conversion funnel. If your  page support a simple user conversion you can use the default value (1).",
    "valueValidators": [
      {
        "type": "NON_EMPTY"
      }
    ]
  },
  {
    "type": "TEXT",
    "name": "order_id",
    "displayName": "Order ID",
    "simpleValueType": true,
    "canBeEmptyString": true,
    "help": "Unique conversion identifier which must be generated by your landing page and populated for each transaction."
  },
  {
    "type": "SELECT",
    "name": "use_revenue_share",
    "displayName": "Use revenue share",
    "macrosInSelect": false,
    "selectItems": [
      {
        "value": 0,
        "displayValue": "No"
      },
      {
        "value": 1,
        "displayValue": "Yes"
      }
    ],
    "simpleValueType": true,
    "defaultValue": 0,
    "help": "Enable when using a revenue share agreement with Across."
  },
  {
    "type": "TEXT",
    "name": "commission_amount",
    "displayName": "Commission amount on user purchase",
    "simpleValueType": true,
    "help": "Mandatory when using a revenue share agreement.",
    "defaultValue": 0,
    "valueUnit": "Euro (€)",
    "enablingConditions": [
      {
        "paramName": "use_revenue_share",
        "paramValue": 1,
        "type": "EQUALS"
      }
    ],
    "valueValidators": [
      {
        "type": "NON_EMPTY"
      },
      {
        "type": "REGEX",
        "args": [
          "[0-9]+(\\.[0-9]{1,2})?"
        ]
      }
    ]
  },
  {
    "type": "TEXT",
    "name": "total_amount",
    "displayName": "Total user purchase amount",
    "simpleValueType": true,
    "help": "Mandatory when using a revenue share agreement.",
    "defaultValue": 0,
    "valueUnit": "Euro (€)",
    "enablingConditions": [
      {
        "paramName": "use_revenue_share",
        "paramValue": 1,
        "type": "EQUALS"
      }
    ],
    "valueValidators": [
      {
        "type": "REGEX",
        "args": [
          "[0-9]+(\\.[0-9]{1,2})?"
        ]
      },
      {
        "type": "NON_EMPTY"
      }
    ]
  }
]


___SANDBOXED_JS_FOR_WEB_TEMPLATE___

const queryPermission = require('queryPermission');
const makeNumber = require('makeNumber');
const encodeUriComponent = require('encodeUriComponent');
const sendPixel = require('sendPixel');

//My pixel url template
const baseUrlTemplate = 'https://affiliate.across.it/v2/az[action_number][campaign_id]/';

//Url specific customization
let baseUrl = baseUrlTemplate;
baseUrl = baseUrl.replace('[action_number]', makeNumber(data.action_number));
baseUrl = baseUrl.replace('[campaign_id]', makeNumber(data.campaign_id));
if (data.order_id){
  baseUrl += encodeUriComponent(data.order_id)+'/';
}

//Management of optional revenue share info, if enabled
if (data.use_revenue_share && data.use_revenue_share == '1'){
  //Commission commission amount
  if (makeNumber(data.commission_amount) > 0){
    baseUrl += encodeUriComponent(data.commission_amount)+'/';
  }
  //Total amount
  if (makeNumber(data.total_amount) > 0){
    //If is not available commission amount but only total amount I have to set commission to zero
    if (makeNumber(data.commission_amount) <= 0){
      baseUrl += '0/';
    }
    baseUrl += encodeUriComponent(data.total_amount)+'/';
  }
}

// sendPixel
if (queryPermission('send_pixel', baseUrl)) {
  sendPixel(baseUrl);
}

data.gtmOnSuccess();


___WEB_PERMISSIONS___

[
  {
    "instance": {
      "key": {
        "publicId": "send_pixel",
        "versionId": "1"
      },
      "param": [
        {
          "key": "allowedUrls",
          "value": {
            "type": 1,
            "string": "specific"
          }
        },
        {
          "key": "urls",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 1,
                "string": "https://affiliate.across.it/*"
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  }
]


___TESTS___

scenarios: []


___NOTES___

Created on 1/9/2020, 10:14:13


